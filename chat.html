<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Minimal Chat</title>
    <style>
        body { 
            font-family: monospace; 
            margin: 0; 
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .content { 
            flex: 1;
            padding: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        #messages { 
            border: 1px solid #ccc; 
            flex: 1;
            overflow-y: auto; 
            padding: 10px; 
            margin-bottom: 10px; 
        }
        .input-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #ccc;
            padding: 10px;
            display: flex;
            gap: 10px;
        }
        #input { 
            flex: 1;
            padding: 5px; 
        }
        #send { 
            padding: 5px 10px; 
        }
        .message { 
            margin: 5px 0; 
            padding: 5px; 
            border-bottom: 1px dotted #eee;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .message-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .status { font-size: 12px; color: #666; }
        .message-id { font-size: 10px; color: #999; font-family: monospace; }
    </style>
</head>
<body>
    <div class="content">
        <!-- Status Info -->
        <div class="status">
            Status: <span id="connectionStatus">Connecting...</span><br>
            Conversation ID: <span id="conversationId">-</span>
        </div>
        
        <hr>
        
        <!-- Messages -->
        <div id="messages">
            <div class="status">Waiting for connection...</div>
        </div>
    </div>
    
    <!-- Input Bar (Fixed at Bottom) -->
    <div class="input-bar">
        <input type="text" id="input" placeholder="Type your message..." />
        <button id="send">Send</button>
    </div>
    
    <script>
        let ws = null;
        let conversationId = null;
        let chatStateActor = null;
        
        const statusEl = document.getElementById('connectionStatus');
        const messagesEl = document.getElementById('messages');
        const inputEl = document.getElementById('input');
        const sendBtn = document.getElementById('send');
        const conversationIdEl = document.getElementById('conversationId');
        
        function connect() {
            const wsUrl = `ws://${window.location.host}/ws`;
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                statusEl.textContent = 'Connected';
                statusEl.style.color = 'green';
                clearMessages();
                addMessage('system', 'WebSocket connected');
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (e) {
                    addMessage('error', `Parse error: ${e.message}`);
                }
            };
            
            ws.onclose = () => {
                statusEl.textContent = 'Disconnected';
                statusEl.style.color = 'red';
                addMessage('system', 'WebSocket disconnected');
                // Auto-reconnect after 3 seconds
                setTimeout(connect, 3000);
            };
            
            ws.onerror = (error) => {
                statusEl.textContent = 'Error';
                statusEl.style.color = 'red';
                addMessage('error', `WebSocket error: ${error}`);
            };
        }
        
        function handleMessage(data) {
            console.log('Received:', data);
            
            switch (data.type) {
                case 'connected':
                    conversationId = data.conversation_id;
                    conversationIdEl.textContent = conversationId;
                    addMessage('system', `Connected to conversation: ${conversationId}`);
                    // Request conversation history
                    sendMessage({ type: 'get_conversation' });
                    break;
                    
                case 'message_added':
                case 'message_update':
                    displayMessage(data.message);
                    break;
                    
                case 'conversation_state':
                    clearMessages();
                    addMessage('system', `Loaded ${data.messages.length} messages`);
                    data.messages.forEach(msg => displayMessage(msg));
                    break;
                    
                case 'error':
                    addMessage('error', data.message);
                    break;
                    
                default:
                    addMessage('unknown', `Unknown message type: ${data.type}`);
            }
        }
        
        function displayMessage(msg) {
            const div = document.createElement('div');
            div.className = `message ${msg.role}`;
            
            // Create message ID element
            const idDiv = document.createElement('div');
            idDiv.className = 'message-id';
            idDiv.textContent = `ID: ${msg.id}`;
            
            // Create message content element
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = getDisplayText(msg);
            
            div.appendChild(idDiv);
            div.appendChild(contentDiv);
            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        function getDisplayText(msg) {
            // Simple text extraction from rich message content
            if (msg.display_text && msg.display_text.trim()) {
                return msg.display_text;
            }
            
            // Fallback: extract from content array
            if (msg.content && Array.isArray(msg.content)) {
                const textParts = msg.content
                    .filter(c => c.Text)
                    .map(c => c.Text);
                if (textParts.length > 0) {
                    return textParts.join('\n');
                }
            }
            
            return '[No text content]';
        }
        
        function addMessage(type, text) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = `<strong>${type}:</strong> ${text}`;
            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        function clearMessages() {
            messagesEl.innerHTML = '';
        }
        
        function sendMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
            }
        }
        
        function sendUserMessage() {
            const text = inputEl.value.trim();
            if (text && ws && ws.readyState === WebSocket.OPEN) {
                sendMessage({
                    type: 'send_message',
                    content: text
                });
                inputEl.value = '';
            }
        }
        
        // Event listeners
        sendBtn.addEventListener('click', sendUserMessage);
        inputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendUserMessage();
            }
        });
        
        // Start connection
        connect();
    </script>
</body>
</html>